# Nova Social Vulnerability Index (CDC)

# setwd("~/dspg2020Loudon")

# install.packages("rgdal)
library(rgdal)
library(tidyverse)
library(sf)
library(dplyr)
library(ggplot2)
library(tidycensus)


myACSkey <- "2580514e97d888fe585f59b4e328fce92342fe8f"
map  <- st_read("~/data/VirginiaShapeFiles/tl_2019_51_tract.shp", stringsAsFactors = FALSE)

dataCDC <- read.csv("~/data/Virginia_CDC_SVI.csv")

# str(map)
# str(dataCDC)

nova_counties  <- c("Arlington",
                    "Fairfax",
                    "Loudoun",
                    "Prince William",
                    "Alexandria City",
                    "Falls Church City",
                    "Fairfax City",
                    "Manassas City",
                    "Manassas Park City",
                    "Fauquier")

dataCDC_modified <- dataCDC %>%
  filter(COUNTY %in% nova_counties ) %>%
  separate(LOCATION, into = c("NAMELSAD", "State"), sep= ", ")

# unique(dataCDC_modified$COUNTY)

# join data with shape file 
map_and_data <- inner_join(map, dataCDC_modified, by="NAMELSAD")


# str(map_and_data)

map_and_data$RPL_THEMES[map_and_data$RPL_THEMES<0] <- NA

# unique(map_and_data$RPL_THEMES)

#Get county outlines for NoVa
va_sf<-get_acs(geography = "county",
               state="VA",
               county=c("Arlington county",
                        "Fairfax county",
                        "Loudoun county",
                        "Prince William county",
                        "Alexandria city",
                        "Falls Church city",
                        "Fairfax city",
                        "Manassas city",
                        "Manassas Park city",
                        "Fauquier County"),
               variables = "B19058_002",
               survey = "acs5",
               key = myACSkey,
               year=2018,
               output = "wide",
               show_call = T,
               geometry = T,
               keep_geo_vars = T)%>%
  select(COUNTYFP,geometry)

# Get Loudoun County Outline only
loudoun_outline<-get_acs(geography = "county",
               state="VA",
               county=c("Loudoun county"),
               variables = "B19058_002",
               survey = "acs5",
               key = myACSkey,
               year=2018,
               output = "wide",
               show_call = T,
               geometry = T,
               keep_geo_vars = T)%>%
  select(COUNTYFP,geometry)

#SVI for NOVA plot
ggplot(map_and_data) + 
  geom_sf(aes(fill= RPL_THEMES)) +
  geom_sf(data=va_sf, fill="transparent", color="black", size=.5) +
  geom_sf(data=loudoun_outline, fill="transparent", color="red", size=.75) +
  ylim(-38.4,-39.3) + xlim(-78.1, -77) + 
  scale_fill_viridis_c() + scale_color_viridis_c() +
  theme(legend.title = element_blank()) 





